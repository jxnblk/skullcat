
plangular.directive('animangular', function($rootScope, $timeout, $interval) {
  var keyframes = {
    1: { log: 'o hai', eyes: true },
    64: { eyes: true, flash: true, skull: true },
    65: { eyes: true },
    66: { eyes: true, flash: true, skull: true },
    70: { eyes: true },
    76: { eyes: true, flash: true, skull: true },
    77: { eyes: true },
    78: { eyes: true, flash: true, skull: true },
    80: { eyes: true },
    90: { eyes: true, flash: true, skull: true },
    92: { eyes: true },
    94: { eyes: true, flash: true, skull: true },
    95: { eyes: true },
    96: { eyes: true, flash: true, skull: true },
    98: { eyes: true },
    110: { eyes: true, flash: true, skull: true },
    111: { eyes: true },
    // 8.1 - 112
    112: { eyes: true, flash: true, skull: true },
    113: { eyes: true },
    114: { eyes: true, flash: true, skull: true },
    115: { eyes: true },
    116: { eyes: true, flash: true, skull: true },
    117: { eyes: true },
    118: { eyes: true, flash: true, skull: true },
    119: { eyes: true },
    120: { eyes: true, flash: true, skull: true },
    121: { eyes: true },
    122: { eyes: true, flash: true, skull: true },
    123: { eyes: true },
    // 9.1
    128: { dot: true, strobe: true, skullGlow: true },
    134: { dot2: true, skullGlow:true },
    136: { flash: true, skull: true },
    140: { dot: true  },
    144: { flash: true, skull: true },
    146: { dot2: true, flash: true, skull: true },
    150: { dot2: true },
    152: { flash: true, dot: true },
    158: { dot2: true },
    160: { dot2: true, flash: true, skull: true },
    164: { dot: true },
    170: { dot2: true },
    // 11.1 - 176 build up
    172: { flash: true, skull: true },
    173: {},
    174: { flash: true, skull: true },
    175: {},
    176: { flash: true, skull: true },
    177: {},
    178: { flash: true, skull: true },
    179: {},
    180: { flash: true, skull: true },
    181: {},
    182: { flash: true, skull: true },
    183: {},
    184: { flash: true, skull: true },
    185: {},
    186: { flash: true, skull: true },
    187: {},
    188: { flash: true, skull: true },
    189: {},
    190: { flash: true, skull: true },
    191: {},
    192: { dot: true, flash: true, skullGlow: true, zag: true },
    198: { dot2: true, skullGlow: true, zag: true },
    200: { flash: true, skull: true },
    204: { dot: true, skull: true },
    207: {},
    208: { skull: true },
    210: { dot2: true },
    216: { dot: true },
    222: { dot2: true },
    224: { flash: true, skull: true },
    228: { dot: true, skull: true },
    234: { dot2: true },

    // 16.1 - build up
    240: { dot: true, flash: true, skull: true },
    241: { flash: false, skull: false },
    242: { flash: true, skull: true },
    243: { flash: false, skull: false },
    244: { flash: true, skull: true },
    245: { flash: false, skull: false },
    246: { flash: true, skull: true },
    247: { flash: false, skull: false },
    248: { flash: true, skull: true },
    249: { flash: false, skull: false },
    250: { flash: true, skull: true },
    251: { flash: false, skull: false },
    251: { flash: true, skull: true },
    252: { flash: false, skull: false },
    254: {},
 
    // 17.1 - splash
    256: { flash: true, skullGlow: true, diamond: true, zag: true },
    260: { skullGlow: true, diamond: true, diamond2: true },
    264: { flash: true, skullGlow: true, diamond: true, diamond2: true },
    268: { skullGlow: true, diamond: true, diamond2: true },
    272: { flash: true, skullGlow: true, diamond: true, diamond2: true, zig1: true },
    276: { skullGlow: true, diamond: true, diamond2: true },
    280: { flash: true, skullGlow: true, diamond: true, diamond2: true, zig2: true },
    286: { skullGlow: true, diamond: true, diamond2: true },
    288: { flash: true, skullGlow: true, diamond: true, diamond2: true, zag: true },
    292: { skullGlow: true, diamond: true, diamond2: true },
    296: { flash: true, skull: true, zig1: true },
    
    300: { flash: true, skull: true },
    301: {},
    302: { flash: true, skull: true },
    303: {},
    // 20.1 - 304 build up
    304: { flash: true, skull: true, zig2: true },
    305: {},
    306: { flash: true, skull: true, zig1: true },
    307: {},
    308: { flash: true, skull: true, zig2: true },
    309: {},
    310: { flash: true, skull: true, zig1: true },
    311: {},
    312: { flash: true, skull: true, zig2: true },
    313: {},
    314: { flash: true, skull: true, zig1: true },
    315: {},
    316: { flash: true, skull: true, zig2: true },
    317: {},
    318: { flash: true, skull: true, zig1: true },
    319: {},
    // 21.1 - 320 splash
    320: { strobe: true, skullGlow: true, diamond: true, ringWarp: true, stars: true },
    328: { skullGlow: true, diamond: true, ringWarp: true, stars: true },
    336: { strobe: true, skullGlow: true, diamond: true },
    344: { skullGlow: true, diamond: true },
    352: { skullGlow: true, diamond: true, zag: true },
    360: { flash: true, skullGlow: true, diamond: true },

    362: {},
    // 24.1 - 368 build up
    364: { flash: true, skull: true },
    365: {},
    366: { flash: true, skull: true },
    367: {},
    368: { flash: true, skull: true },
    369: {},
    370: { flash: true, skull: true },
    371: {},
    372: { flash: true, skull: true },
    373: {},
    374: { flash: true, skull: true },
    375: {},
    376: { flash: true, skull: true },
    377: {},
    378: { flash: true, skull: true },
    379: {},
    380: { flash: true, skull: true },
    381: {},
    382: { flash: true, skull: true },
    383: {},
    // 25.1 - 384 splash
    384: { dot: true, skullGlow: true },
    390: { dot2: true, skullGlow: true },
    392: { dot2: true, skullGlow: true, zig1: true, flash: true },
    396: { dot: true, skullGlow: true },
    400: { flash: true, dot: true, skullGlow: true },
    402: { flash: true, dot2: true, skullGlow: true },
    408: { dot: true, skullGlow: true, zig2: true, flash: true },
    414: { dot2: true, skullGlow: true },
    416: { dot2: true, skullGlow: true, flash: true },
    420: { dot: true, skullGlow: true },
    424: { dot: true, skullGlow: true, zig1: true },
    426: { dot2: true, skullGlow: true, zig1: true },
    // 28.1 - 432 build up
    432: { dot: true, flash: true, skull: true },
    433: { dot: true },
    434: { dot: true, flash: true, skull: true },
    435: { dot: true },
    436: { dot: true, flash: true, skull: true },
    437: { dot: true },
    438: { dot2: true, flash: true, skull: true },
    439: { dot2: true },
    440: { dot2: true, flash: true, skull: true },
    441: { dot2: true },
    442: { flash: true, skull: true },
    443: {},
    444: { dot: true, flash: true, skull: true },
    445: { dot: true },
    446: { dot: true, flash: true, skull: true },
    447: {},
    // 29.1 - 448 splash
    448: { dot: true, flash: true, skullGlow: true, ringWarp: true, stars: true },
    454: { dot2: true, skullGlow: true, ringWarp: true, stars: true },
    460: { dot: true, skullGlow: true, ringWarp: true, stars: true },
    466: { dot2: true, skullGlow: true },
    472: { dot: true, skullGlow: true },
    478: { dot2: true, skullGlow: true },
    484: { dot: true, skullGlow: true },
    490: { dot2: true, skullGlow: true },


    // 32.1 - 496 build up
    492: { flash: true, skull: true },
    493: {},
    494: { flash: true, skull: true },
    495: {},
    496: { flash: true, skull: true },
    497: {},
    498: { flash: true, skull: true },
    499: {},
    500: { flash: true, skull: true },
    501: {},
    502: { flash: true, skull: true },
    503: {},
    504: { flash: true, skull: true },
    505: {},
    506: { flash: true, skull: true },
    507: {},
    508: { flash: true, skull: true },
    509: {},
    510: { flash: true, skull: true },
    511: {},
    // 33.1 - 512 splash - break
    512: { flash: true, skullGlow: true, zag: true },
    516: { skullGlow: true },
    520: { flash: true, skullGlow: true, zig1: true },
    528: { strobe: true, skullGlow: true, ringWarp: true, stars: true },
    536: { flash: true, skullGlow: true, ringWarp: true, stars: true },
    544: { skullGlow: true, zag: true },
    548: { skullGlow: true, zig1: true },
    550: { skullGlow: true, zig2: true },
    552: { flash: true, skull: true },

    556: { flash: true, skull: true },
    557: {},
    558: { flash: true, skull: true },
    559: {},
    // 36.1 - 560 - build up
    560: { flash: true, skull: true },
    561: {},
    562: { flash: true, skull: true },
    563: {},
    564: { flash: true, skull: true },
    565: {},
    566: { flash: true, skull: true },
    567: {},
    568: { flash: true, skull: true },
    569: {},
    570: { flash: true, skull: true },
    571: {},
    572: { flash: true, skull: true },
    573: {},
    574: { flash: true, skull: true },
    575: {},
    // 576 splash
    576: { strobe: true, skullGlow: true, ringWarp: true },
    584: { flash: true, skullGlow: true },
    588: { skullGlow: true },
    592: { flash: true, skull: true, stars: true },
    596: { stars: true, ringWarp: true, diamond: true, diamond2: true },
    600: { flash: true, skullGlow: true, stars: true, ringWarp: true, zig1: true, zig2: true, diamond: true, diamond2: true },
    604: { skullGlow: true, stars: true, ringWarp: true, diamond: true, diamond2: true },
    608: { flash: true, skull: true, stars: true, ringWarp: true },
    612: { stars: true, ringWarp: true },
    616: { flash: true, skull: true, zag: true },
    618: {},
    
    620: { flash: true, skull: true },
    621: {},
    622: { flash: true, skull: true },
    623: {},
    // 40.1 - 624 - build up
    624: { flash: true, skull: true },
    625: {},
    626: { flash: true, skull: true },
    627: {},
    628: { flash: true, skull: true },
    629: {},
    630: { flash: true, skull: true },
    631: {},
    632: { flash: true, skull: true },
    633: {},
    634: { flash: true, skull: true },
    635: {},
    636: { flash: true, skull: true },
    637: {},
    638: { flash: true, skull: true },
    639: {},

    // 640 splash
    640: { flash: true, skullGlow: true, zag: true },
    644: { skullGlow: true, zig1: true },
    648: { flash: true, skullGlow: true, zig2: true },
    656: { strobe: true, skullGlow: true, ringWarp: true, stars: true },
    664: { flash: true, skullGlow: true, stars: true, zig1: true },
    668: { skullGlow: true, stars: true, zig2: true },
    672: { flash: true, skullGlow: true, zag: true },
    680: { strobe: true, skullGlow: true },
    
    684: { flash: true, skull: true },
    685: {},
    686: { flash: true, skull: true },
    687: {},
    688: { flash: true, skull: true },
    685: {},
    // 44.1 - 688 - build up
    688: { flash: true, skull: true },
    689: {},
    690: { flash: true, skull: true },
    691: {},
    692: { flash: true, skull: true },
    693: {},
    694: { flash: true, skull: true },
    695: {},
    696: { flash: true, skull: true },
    697: {},
    698: { flash: true, skull: true },
    699: {},
    700: { flash: true, skull: true },
    701: {},
    702: { flash: true, skull: true },
    703: {},
    // 704 splash
    704: { dot: true, strobe: true, skullGlow: true, ringWarp: true, stars: true },
    710: { dot2: true, strobe: true, skullGlow: true, ringWarp: true, stars: true },
    712: { flash: true, skullGlow: true, diamond: true },
    716: { dot: true, skullGlow: true, diamond: true, diamond2: true },
    720: { strobe: true, skullGlow: true, diamond: true, diamond2: true },
    722: { dot2: true, strobe: true, skullGlow: true, diamond: true, diamond2: true },
    728: { dot: true, skullGlow: true, diamond: true, diamond2: true },
    734: { dot2: true, skullGlow: true, diamond: true, diamond2: true },
    736: { flash: true, skull: true },
    740: { dot: true },
    744: { flash: true, skullGlow: true, zag: true },
    746: { dot2: true, skullGlow: true, zag: true },

    748: { flash: true, skull: true },
    749: {},
    750: { flash: true, skull: true },
    751: {},
    // 48.1 - 752 - build up
    752: { flash: true, skull: true },
    753: {},
    754: { flash: true, skull: true },
    755: {},
    756: { flash: true, skull: true },
    757: {},
    758: { flash: true, skull: true },
    759: {},
    760: { flash: true, skull: true },
    761: {},
    762: { flash: true, skull: true },
    763: {},
    764: { flash: true, skull: true },
    765: {},
    766: { flash: true, skull: true },
    767: {},
    // 768 splash
    768: { strobe: true, skullGlow: true, ringWarp: true, stars: true },
    776: { flash: true, skull: true, ringWarp: true, stars: true },
    780: { zig1: true },
    782: { zig2: true },
    784: { strobe: true, skullGlow: true, zag: true },
    792: { flash: true, skull: true },
    796: { zig1: true, zag: true },
    798: { zig2: true, zag: true },
    800: { strobe: true, skullGlow: true, diamond: true },
    804: { strobe: true, skullGlow: true, diamond: true, diamond2: true },
    808: { flash: true, skullGlow: true, diamond: true, diamond2: true, ringWarp: true },
    808: { strobe: true, skullGlow: true, diamond: true, diamond2: true, ringWarp: true, stars: true },
    812: { flash: true, skull: true, ringWarp: true, stars: true },
    813: { ringWarp: true, stars: true },
    814: { flash: true, skull: true, ringWarp: true, stars: true },
    815: { ringWarp: true, stars: true },
    // 52.1 - 816 - build up
    816: { flash: true, skull: true, ringWarp: true, stars: true },
    817: { ringWarp: true, stars: true },
    818: { flash: true, skull: true, ringWarp: true, stars: true },
    819: { ringWarp: true, stars: true },
    820: { flash: true, skull: true, ringWarp: true, stars: true },
    821: { ringWarp: true, stars: true },
    822: { flash: true, skull: true, ringWarp: true, stars: true },
    823: { ringWarp: true, stars: true },
    824: { flash: true, skull: true, ringWarp: true, stars: true },
    825: { ringWarp: true, stars: true },
    826: { flash: true, skull: true, ringWarp: true, stars: true },
    827: { ringWarp: true, stars: true },
    828: { flash: true, skull: true, ringWarp: true, stars: true },
    829: { ringWarp: true, stars: true },
    830: { flash: true, skull: true, ringWarp: true, stars: true },
    831: { ringWarp: true, stars: true },

    // 832 splash
    832: { strobe: true, skullGlow: true, zag: true, diamond: true },
    836: { strobe: true, skullGlow: true, zag: true, diamond: true, diamond2: true },
    840: { flash: true, skull: true, diamond: true, diamond2: true, stars: true, ringWarp: true },
    848: { strobe: true, skullGlow: true, zag: true },
    852: { strobe: true, skullGlow: true, zig1: true },
    856: { flash: true, skullGlow: true, zig2: true },
    860: { skullGlow: true, zag: true },
    864: { flash: true, skullGlow: true, diamond: true },
    868: { skullGlow: true, diamond: true, diamond2: true },
    872: { skullGlow: true, diamond: true, diamond2: true },
    
    
    // 56.1 - 880 - build up
    876: { flash: true, skull: true },
    877: {},
    878: { flash: true, skull: true },
    879: {},
    880: { flash: true, skull: true },
    881: {},
    882: { flash: true, skull: true },
    883: {},
    884: { flash: true, skull: true },
    885: {},
    886: { flash: true, skull: true },
    887: {},
    888: { flash: true, skull: true },
    889: {},
    890: { flash: true, skull: true },
    891: {},
    892: { flash: true, skull: true },
    893: {},
    894: { flash: true, skull: true },
    895: {},
    // 896 splash
    896: { strobe: true, skullGlow: true, ringWarp: true, stars: true },
    904: { flash: true, skull: true, ringWarp: true, stars: true, zag: true },
    912: { strobe: true, ringWarp: true, stars: true, zig1: true },
    914: { strobe: true, ringWarp: true, stars: true, zig2: true },
    916: { strobe: true, ringWarp: true, stars: true, zig1: true },
    918: { strobe: true, ringWarp: true, stars: true, zig2: true },
    920: { flash: true, skull: true, ringWarp: true, stars: true },
    928: { strobe: true, zag: true, ringWarp: true, stars: true },
    936: { flash: true, zig1: true, zig2: true, ringWarp: true, stars: true },
    938: { ringWarp: true, stars: true },
    
    940: { flash: true, skull: true },
    941: {},
    942: { flash: true, skull: true },
    943: {},
    // 60.1 - 944 - build up
    944: { flash: true, skull: true },
    945: {},
    946: { flash: true, skull: true },
    947: {},
    948: { flash: true, skull: true },
    949: {},
    950: { flash: true, skull: true },
    951: {},
    952: { flash: true, skull: true },
    953: {},
    954: { flash: true, skull: true },
    955: {},
    956: { flash: true, skull: true },
    957: {},
    958: { flash: true, skull: true },
    959: {},
    // 960 splash
    960: { strobe: true, skullGlow: true, zag: true, ringWarp: true, stars: true },
    964: { strobe: true, skullGlow: true, zig1: true, ringWarp: true, stars: true },
    968: { flash: true, skull: true, zig2: true, ringWarp: true, stars: true },
    972: { zig1: true },
    974: { zig2: true },
    976: { strobe: true, skullGlow: true, ringWarp: true, stars: true },
    984: { flash: true, skull: true },
    988: { zag: true },
    990: { zig1: true },
    992: { flash: true, skull: true, zig2: true, diamond: true },
    996: { diamond: true, diamond2: true },
    
    1004: { flash: true, skullGlow: true, zag: true },
    1105: {},
    1006: { flash: true, skullGlow: true, zig1: true },
    1107: {},
    // 64.1 - 1008 - build up
    1008: { flash: true, skull: true, zig2: true },
    1009: {},
    1010: { flash: true, skull: true, dot: true },
    1011: {},
    1012: { flash: true, skull: true, dot2: true },
    1013: {},
    1014: { flash: true, skull: true, zag: true },
    1015: {},
    1016: { flash: true, skull: true, diamond: true },
    1017: { diamond: true },
    1018: { flash: true, skull: true, ringWarp: true },
    1019: { ringWarp: true },
    1020: { flash: true, skull: true, stars: true },
    1021: { stars: true },
    1022: { flash: true, skull: true },
    1023: {},
    1024: { strobe: true, skullGlow: true, ringWarp: true, stars: true },
    1028: { flash: true, skull: true },

    //1024 splash
  };
  return {
    restrict: 'A',
    scope: true,
    link: function(scope, elem, attrs) {
      //console.log('A N I M A N G U L A R');
      var audio = $rootScope.audio;
      var ms;
      var counter;
      var timer;
      var bar = 1 ;
      var beat = 1;
      var oldbeat;
      var step;
      scope.ms = ms;
      var setCounter = function() {
        $interval.cancel(timer);
        var counter = function(){
          ms = Math.floor(audio.currentTime * 10) * 100;
          if(keyframes[step]) {
            scope.frame = keyframes[step];
          }
          scope.ms = Math.floor(ms);
          // 144 bpm // 2.4 bps // 0.0024 bpms
          step = Math.floor(ms * .0096) + 1;
          bar = Math.floor(step/16) + 1;
          beat = Math.floor(step/4) - ((bar - 1) * 4) + 1;
          if (beat != oldbeat) {
            //console.log(bar + '.' + beat + ' : ' + step);
          }
          scope.bar = bar;
          scope.beat = beat;
          oldbeat = beat;
        };
        timer = $interval(counter,24);
      };
      audio.addEventListener('playing', function() {
        setCounter();
      });
      audio.addEventListener('pause', function() {
        console.log('paused');
        $interval.cancel(timer);
      });
      audio.addEventListener('seeked', function() {
        setCounter();
      });
    }
  }
});

